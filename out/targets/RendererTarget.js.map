{"version":3,"file":"RendererTarget.js","sourceRoot":"","sources":["../../src/targets/RendererTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { Lazy } from \"lazy-val\"\nimport * as path from \"path\"\nimport { getConfig } from \"read-config-file\"\nimport { DefinePlugin } from \"webpack\"\nimport { getDllAssets } from \"../configurators/dll\"\nimport { configureVueRenderer } from \"../configurators/vue/vue\"\nimport { WebpackConfigurator } from \"../main\"\nimport { statOrNull } from \"../util\"\nimport { BaseTarget, configureFileLoader } from \"./BaseTarget\"\n\nconst ExtractTextPlugin = require(\"extract-text-webpack-plugin\")\n\nexport class BaseRendererTarget extends BaseTarget {\n  constructor() {\n    super()\n  }\n\n  configureRules(configurator: WebpackConfigurator): void {\n    super.configureRules(configurator)\n\n    configurator.extensions.push(\".css\")\n\n    const cssHotLoader = configurator.isProduction ? [] : [\"css-hot-loader\"]\n\n    configurator.rules.push(\n      {\n        test: /\\.css$/,\n        use: cssHotLoader.concat(ExtractTextPlugin.extract({\n          use: \"css-loader\",\n          fallback: \"style-loader\",\n        })),\n      },\n      {\n        test: /\\.less$/,\n        use: cssHotLoader.concat(ExtractTextPlugin.extract({\n          use: [\n            {loader: \"css-loader\"},\n            {loader: \"less-loader\"}\n          ],\n          fallback: \"style-loader\"\n        }))\n      },\n      {\n        test: /\\.scss/,\n        use: cssHotLoader.concat(ExtractTextPlugin.extract({\n          use: [\n            {loader: \"css-loader\"},\n            {loader: \"sass-loader\"}\n          ],\n          fallback: \"style-loader\"\n        }))\n      },\n      {\n        test: /\\.(png|jpe?g|gif|svg)(\\?.*)?$/,\n        use: {\n          loader: \"url-loader\",\n          options: configureFileLoader(\"imgs\")\n        }\n      },\n      {\n        test: /\\.(mp4|webm|ogg|mp3|wav|flac|aac)(\\?.*)?$/,\n        loader: \"url-loader\",\n        options: configureFileLoader(\"media\"),\n      },\n      {\n        test: /\\.(woff2?|eot|ttf|otf)(\\?.*)?$/,\n        use: {\n          loader: \"url-loader\",\n          options: configureFileLoader(\"fonts\")\n        }\n      },\n    )\n\n    if (configurator.hasDevDependency(\"ejs-html-loader\")) {\n      configurator.rules.push({\n        test: /\\.ejs$/,\n        loader: \"ejs-html-loader\",\n      })\n    }\n\n    if (configurator.hasDependency(\"vue\")) {\n      configureVueRenderer(configurator)\n    }\n    else {\n      configurator.rules.push({\n        test: /\\.(html)$/,\n        use: {\n          loader: \"html-loader\",\n        }\n      })\n    }\n  }\n\n  async configurePlugins(configurator: WebpackConfigurator): Promise<void> {\n    configurator.debug(\"Add ExtractTextPlugin plugin\")\n    configurator.plugins.push(new ExtractTextPlugin(`${configurator.type === \"renderer-dll\" ? \"vendor\" : \"styles\"}.css`))\n\n    // https://github.com/electron-userland/electrify/issues/1\n    if (!configurator.isProduction) {\n      configurator.plugins.push(new DefinePlugin({\n        \"process.env.NODE_ENV\": \"\\\"development\\\"\",\n      }))\n    }\n\n    await BaseTarget.prototype.configurePlugins.call(this, configurator)\n  }\n}\n\nexport class RendererTarget extends BaseRendererTarget {\n  constructor() {\n    super()\n  }\n\n  async configurePlugins(configurator: WebpackConfigurator): Promise<void> {\n    // not configurable for now, as in the electron-vue\n    const customTemplateFile = path.join(configurator.projectDir, \"src/index.ejs\")\n    const HtmlWebpackPlugin = require(\"html-webpack-plugin\")\n    const nodeModulePath = configurator.isProduction ? null : path.resolve(configurator.projectDir, \"node_modules\")\n\n    configurator.plugins.push(new HtmlWebpackPlugin({\n      filename: \"index.html\",\n      template: (await statOrNull(customTemplateFile)) == null ? (await generateIndexFile(configurator, nodeModulePath)) : customTemplateFile,\n      minify: false,\n      nodeModules: nodeModulePath\n    }))\n\n    if (configurator.isProduction) {\n      configurator.plugins.push(new DefinePlugin({\n        __static: `\"${path.join(configurator.projectDir, \"static\").replace(/\\\\/g, \"\\\\\\\\\")}\"`\n      }))\n    }\n    else {\n      const contentBase = [path.join(configurator.projectDir, \"static\"), path.join(configurator.commonDistDirectory, \"renderer-dll\")]\n      configurator.config.devServer = {\n        contentBase,\n        host: process.env.ELECTRON_WEBPACK_WDS_HOST || \"localhost\",\n        port: process.env.ELECTRON_WEBPACK_WDS_PORT || 9080,\n        hot: true,\n        overlay: true,\n      }\n    }\n\n    await BaseRendererTarget.prototype.configurePlugins.call(this, configurator)\n  }\n}\n\nasync function computeTitle(configurator: WebpackConfigurator): Promise<string | null | undefined> {\n  const titleFromOptions = configurator.electronWebpackConfiguration.title\n  if (titleFromOptions == null || titleFromOptions === false) {\n    return null\n  }\n\n  if (titleFromOptions !== true) {\n    return titleFromOptions\n  }\n\n  let title: string | null | undefined = (configurator.metadata as any).productName\n  if (title == null) {\n    const electronBuilderConfig = await getConfig<any>({\n      packageKey: \"build\",\n      configFilename: \"electron-builder\",\n      projectDir: configurator.projectDir,\n      packageMetadata: new Lazy(() => BluebirdPromise.resolve(configurator.metadata))\n    })\n    if (electronBuilderConfig != null) {\n      title = electronBuilderConfig.result.productName\n    }\n  }\n\n  if (title == null) {\n    title = configurator.metadata.name\n  }\n  return title\n}\n\nasync function generateIndexFile(configurator: WebpackConfigurator, nodeModulePath: string | null) {\n  // do not use add-asset-html-webpack-plugin - no need to copy vendor files to output (in dev mode will be served directly, in production copied)\n  const assets = await getDllAssets(path.join(configurator.commonDistDirectory, \"renderer-dll\"), configurator)\n  const scripts: Array<string> = []\n  const css: Array<string> = []\n  for (const asset of assets) {\n    if (asset.endsWith(\".js\")) {\n      scripts.push(`<script type=\"text/javascript\" src=\"${asset}\"></script>`)\n    }\n    else {\n      css.push(`<link rel=\"stylesheet\" href=\"${asset}\">`)\n    }\n  }\n\n  const virtualFilePath = \"/__virtual__/renderer-index.html\"\n\n  const title = await computeTitle(configurator)\n\n  // add node_modules to global paths so \"require\" works properly in development\n  const VirtualModulePlugin = require(\"virtual-module-webpack-plugin\")\n  configurator.plugins.push(new VirtualModulePlugin({\n    moduleName: virtualFilePath,\n    contents: `\n<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset=\"utf-8\">\n    ${title == null ? \"\" : `<title>${title}</title>`}\n    <script>\n      ${nodeModulePath == null ? \"\" : `require(\"module\").globalPaths.push(\"${nodeModulePath.replace(/\\\\/g, \"\\\\\\\\\")}\")`}\n      require(\"source-map-support/source-map-support.js\").install()\n    </script>\n    ${scripts.join(\"\")}\n  ${css.join(\"\")}\n  </head>\n  <body>\n    <div id=\"app\"></div>\n  </body>\n</html>`,\n  }))\n\n  return `!!html-loader?minimize=false!${virtualFilePath}`\n}"]}
