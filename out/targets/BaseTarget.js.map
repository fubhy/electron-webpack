{"version":3,"file":"BaseTarget.js","sourceRoot":"","sources":["../../src/targets/BaseTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from \"path\"\nimport { DefinePlugin, EnvironmentPlugin, HotModuleReplacementPlugin, LoaderOptionsPlugin, NamedModulesPlugin, NoEmitOnErrorsPlugin, optimize } from \"webpack\"\nimport { configureDll } from \"../configurators/dll\"\nimport { configureEslint } from \"../configurators/eslint\"\nimport { createBabelLoader } from \"../configurators/js\"\nimport { WebpackConfigurator } from \"../main\"\nimport { WatchFilterPlugin } from \"../plugins/WatchMatchPlugin\"\nimport { WebpackRemoveOldAssetsPlugin } from \"../plugins/WebpackRemoveOldAssetsPlugin\"\n\nexport class BaseTarget {\n  configureRules(configurator: WebpackConfigurator): void {\n    const rules = configurator.rules\n\n    const babelLoader = createBabelLoader(configurator)\n    if (configurator.type !== \"main\" && configurator.hasDependency(\"iview\")) {\n      rules.push({\n        test: /iview.src.*?js$/,\n        use: babelLoader\n      })\n    }\n\n    rules.push(\n      {\n        test: /\\.js$/,\n        exclude: /(node_modules|bower_components)/,\n        use: babelLoader\n      },\n      {\n        test: /\\.node$/,\n        use: \"node-loader\"\n      },\n    )\n\n    if (configurator.hasDevDependency(\"nunjucks-loader\")) {\n      rules.push({\n        test: /\\.(njk|nunjucks)$/,\n        loader: \"nunjucks-loader\"\n      })\n    }\n\n    configureEslint(configurator)\n  }\n\n  async configurePlugins(configurator: WebpackConfigurator): Promise<void> {\n    const plugins = configurator.plugins\n\n    const dllManifest = await configureDll(configurator)\n\n    if (configurator.isProduction) {\n      if (configurator.env.minify !== false) {\n        const UglifyJsPlugin = require(\"uglifyjs-webpack-plugin\")\n        plugins.push(new UglifyJsPlugin({\n          parallel: true,\n          sourceMap: true,\n          uglifyOptions: {\n            compress: {\n              ecma: 7,\n            },\n          },\n        }))\n      }\n      plugins.push(new DefinePlugin({\n        \"process.env.NODE_ENV\": \"\\\"production\\\"\"\n      }))\n      plugins.push(new LoaderOptionsPlugin({minimize: true}))\n\n      // do not use ModuleConcatenationPlugin for HMR\n      // https://github.com/webpack/webpack-dev-server/issues/949\n      plugins.push(new optimize.ModuleConcatenationPlugin())\n    }\n    else {\n      configureDevelopmentPlugins(configurator)\n    }\n\n    if (configurator.env.autoClean !== false) {\n      plugins.push(new WebpackRemoveOldAssetsPlugin(dllManifest))\n    }\n\n    plugins.push(new NoEmitOnErrorsPlugin())\n\n    const additionalEnvironmentVariables = Object.keys(process.env).filter(it => it.startsWith(\"ELECTRON_WEBPACK_\"))\n    if (additionalEnvironmentVariables.length > 0) {\n      plugins.push(new EnvironmentPlugin(additionalEnvironmentVariables))\n    }\n  }\n}\n\nexport function configureFileLoader(prefix: string, limit = 10 * 1024) {\n  return {\n    limit,\n    name: `${prefix}/[name]--[folder].[ext]`\n  }\n}\n\nfunction isAncestor(file: string, dir: string) {\n  return file.length > dir.length && file[dir.length] === path.sep && file.startsWith(dir)\n}\n\nfunction configureDevelopmentPlugins(configurator: WebpackConfigurator) {\n  const plugins = configurator.plugins\n  plugins.push(new NamedModulesPlugin())\n  plugins.push(new DefinePlugin({\n    __static: `\"${path.join(configurator.projectDir, \"static\").replace(/\\\\/g, \"\\\\\\\\\")}\"`\n  }))\n\n  plugins.push(new HotModuleReplacementPlugin())\n\n  if (configurator.hasDevDependency(\"webpack-build-notifier\")) {\n    const WebpackNotifierPlugin = require(\"webpack-build-notifier\")\n    plugins.push(new WebpackNotifierPlugin({\n      title: `Webpack - ${configurator.type}`,\n      suppressSuccess: \"initial\",\n      sound: false,\n    }))\n  }\n\n  if (configurator.hasDevDependency(\"webpack-notifier\")) {\n    const WebpackNotifierPlugin = require(\"webpack-notifier\")\n    plugins.push(new WebpackNotifierPlugin({title: `Webpack - ${configurator.type}`}))\n  }\n\n  // watch common code\n  let commonSourceDir = configurator.electronWebpackConfiguration.commonSourceDirectory\n  if (commonSourceDir == null) {\n    // not src/common, because it is convenient to just put some code into src to use it\n    commonSourceDir = path.join(configurator.projectDir, \"src\")\n  }\n\n  const alienSourceDir = configurator.getSourceDirectory(configurator.type === \"main\" ? \"renderer\" : \"main\")\n\n  configurator.plugins.push(new WatchFilterPlugin(file => {\n    return file === commonSourceDir || (isAncestor(file, commonSourceDir!!) && (alienSourceDir != null && !file.startsWith(alienSourceDir)))\n  }, require(\"debug\")(`electron-webpack:watch-${configurator.type}`)))\n}\n"]}
